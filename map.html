<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Ubike information</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script>
var map;
var manifest_url = location.href + 'manifest.webapp';
var jsonstr = '';
var markers = [];

function httpGet(url) {
  xmlHttp = new XMLHttpRequest();
  xmlHttp.open( "GET", url, false );
  xmlHttp.send( null );
  return xmlHttp.responseText;
}

function initialize() {
  var myLatlng = new google.maps.LatLng(25.03304,121.5656);
  var maxLat = 26;
  var maxLng = 121.7;
  var minLat = 23;
  var minLng = 121.4;
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(function(pos) {
      lat = pos.coords.latitude;
      lng = pos.coords.longitude;
      console.log("Your position: (Latitude: " + lat +", Longitue: " + lng + ")");
      if (lat < maxLat &&
          lat > minLat &&
          lng < maxLng &&
          lng > minLng) {
        myLatlng = new google.maps.LatLng( lat, lng );
      }
    });
  }

  var mapOptions = {
    zoom: 16,
    center: myLatlng
  }
  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  var iconBase = 'http://oouyang.github.io/ubike/img/';
  var icons = {
    ok: {
      icon: iconBase + 'ok.png'
    },
    empty: {
      icon: iconBase + 'empty.png'
    },
    full: {
      icon: iconBase + 'full.png'
    }
  };

  jsonstr = httpGet('http://ubike.net46.net/ubikejson.php');
  var retVal = JSON.parse(jsonstr).retVal;
  for (i in retVal) {
    latlng = new google.maps.LatLng(retVal[i].lat, retVal[i].lng);
    var type = 'ok';
    if ( retVal[i].sbi == 0 ) {
      type = 'empty';
    } else if ( (retVal[i].tot-retVal[i].sbi) == 0 ) {
      type = 'full';
    }
    var marker = new google.maps.Marker({
         position: latlng,
         map: map,
         icon: icons[type].icon,
         //animation: google.maps.Animation.DROP,
         title: retVal[i].ar + "\n(" + retVal[i].sbi + "/" + (retVal[i].tot-retVal[i].sbi) + ")"
    });
    markers.push(marker);
    (function(marker, i) {
        var infowindow = new google.maps.InfoWindow({
            content: '<div id="content">'+
          '<div id="siteNotice">'+
          '</div>'+
          '<h3 id="firstHeading" class="firstHeading">'+retVal[i].sna+'</h3>'+
          '<div id="bodyContent">'+
          '&#31449;&#40670;&#20301;&#32622; : ' +retVal[i].ar+
          '<br>&#21487;&#20511;&#36554;&#36635; : ' +retVal[i].sbi+ ' &#36635; ' +
          '<br>&#21487;&#20572;&#31354;&#20301; : ' +(retVal[i].tot-retVal[i].sbi)+ ' &#36635; ' + '</div>'+
          '</div>'
          });
        google.maps.event.addListener(marker, 'mouseover', function() {
            infowindow.open(map, marker)
        });

        google.maps.event.addListener(marker, 'mouseout', function() {
            t = setTimeout(function() {
                infowindow.close()
            }, 3000);
        });
        google.maps.event.addListener(marker, 'click', function() {
          infowindow.open(map, marker);
        });
     })(marker, i);

      var routeCoords = [];
      var routePath ;
      function geo_success(position) {
        routeCoords.push(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
        routePath = new google.maps.Polyline({
          path: routeCoords,
          strokeColor: "#0000FF",
          strokeOpacity: 1.0,
          strokeWeight: 2
        });
        routePath.setMap(map);
      }

      function geo_error() {
        console.log("Sorry, no position available.");
      }

      var geo_options = {
        enableHighAccuracy: true, 
        maximumAge        : 0, 
        timeout           : 2000
      };

      var wpid = navigator.geolocation.watchPosition(geo_success, geo_error, geo_options);
     // get a reference to the button and call install() on click if the app isn't already installed. If it is, hide the button.
     /*
     var button = document.getElementById('install-btn');

     var installCheck = navigator.mozApps.checkInstalled(manifest_url);

     installCheck.onsuccess = function() {
       if(installCheck.result) {
         button.style.display = "none";
       } else {
         button.addEventListener('click', install, false);
       };
     };
     */
  }
}
/*
function install(ev) {
  ev.preventDefault();
  // define the manifest URL
  // install the app
  var installLocFind = navigator.mozApps.install(manifest_url);
  installLocFind.onsuccess = function(data) {
    // App is installed, do something
  };
  installLocFind.onerror = function() {
    // App wasn't installed, info is in
    // installapp.error.name
    alert(installLocFind.error.name);
  };
};

function toggleBounce() {

  if (marker.getAnimation() != null) {
    marker.setAnimation(null);
  } else {
    marker.setAnimation(google.maps.Animation.BOUNCE);
  }
}
function onBoundsChanged() {
bounds = map.getBound();
console.log(bounds);
}*/
google.maps.event.addDomListener(window, 'load', initialize);
//google.maps.event.addDomListener(window, 'bounds_changed', onBoundsChanged);
    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-56849136-1', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>